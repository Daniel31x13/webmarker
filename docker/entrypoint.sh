#!/bin/bash

# Get PUID/PGID
PUID=${PUID:-911}
PGID=${PGID:-911}
BASH_SOURCE=${BASH_SOURCE:-$0}

add_user() {
    groupmod -o -g "$PGID" abc
    usermod -o -u "$PUID" abc
}

change_user() {
    if [ "$(id -u)" = $PUID ]; then
        echo "
        User uid:    $PUID
        User gid:    $PGID
        "
    elif [ "$(id -u)" = "0" ]; then
        # If container is started as root then create a new user and switch to it
        add_user
        chown -R $PUID:$PGID /data

        echo "Switching to dedicated user"
        exec gosu $PUID "$BASH_SOURCE"
    fi
}


check_postgres_connection(){
    if    [[ -n ${POSTGRES_HOST} \
          && -n ${POSTGRES_PASSWORD} \
          && -n ${POSTGRES_USER}  \
          && -z ${DATABASE_URL+x} ]];then
        export DATABASE_URL="postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:5432/linkwarden"
    fi
}

load_secrets() {
    # All the environment variables will support a `_FILE` suffix that allows
    # for setting the environment variable through the Docker Compose secret
    # pattern.
    local -a secret_supported_vars=(
        "POSTGRES_USER"
        "POSTGRES_PASSWORD"
        "POSTGRES_HOST"
        "DATABASE_URL"
        "NEXTAUTH_URL"
        "NEXTAUTH_SECRET"
        "SPACES_KEY"
        "SPACES_SECRET"
        "SPACES_ENDPOINT"
        "SPACES_BUCKET_NAME"
        "SPACES_REGION"
        "SPACES_FORCE_PATH_STYLE"
        "NEXT_PUBLIC_EMAIL_PROVIDER"
        "EMAIL_FROM"
        "EMAIL_SERVER"
        "BASE_URL"
        "PROXY"
        "PROXY_USERNAME"
        "PROXY_PASSWORD"
        "PROXY_BYPASS"
        "PDF_MARGIN_TOP"
        "PDF_MARGIN_BOTTOM"
        "NEXT_PUBLIC_FORTYTWO_ENABLED"
        "FORTYTWO_CUSTOM_NAME"
        "FORTYTWO_CLIENT_ID"
        "FORTYTWO_CLIENT_SECRET"
        "NEXT_PUBLIC_APPLE_ENABLED"
        "APPLE_CUSTOM_NAME"
        "APPLE_ID"
        "APPLE_SECRET"
        "NEXT_PUBLIC_ATLASSIAN_ENABLED"
        "ATLASSIAN_CUSTOM_NAME"
        "ATLASSIAN_CLIENT_ID"
        "ATLASSIAN_CLIENT_SECRET"
        "ATLASSIAN_SCOPE"
        "NEXT_PUBLIC_AUTH0_ENABLED"
        "AUTH0_CUSTOM_NAME"
        "AUTH0_ISSUER"
        "AUTH0_CLIENT_SECRET"
        "AUTH0_CLIENT_ID"
        "NEXT_PUBLIC_AUTHELIA_ENABLED"
        "AUTHELIA_CLIENT_ID"
        "AUTHELIA_CLIENT_SECRET"
        "AUTHELIA_WELLKNOWN_URL"
        "NEXT_PUBLIC_AUTHENTIK_ENABLED"
        "AUTHENTIK_CUSTOM_NAME"
        "AUTHENTIK_ISSUER"
        "AUTHENTIK_CLIENT_ID"
        "AUTHENTIK_CLIENT_SECRET"
        "NEXT_PUBLIC_AZURE_AD_B2C_ENABLED"
        "AZURE_AD_B2C_TENANT_NAME"
        "AZURE_AD_B2C_CLIENT_ID"
        "AZURE_AD_B2C_CLIENT_SECRET"
        "AZURE_AD_B2C_PRIMARY_USER_FLOW"
        "NEXT_PUBLIC_AZURE_AD_ENABLED"
        "AZURE_AD_CLIENT_ID"
        "AZURE_AD_CLIENT_SECRET"
        "AZURE_AD_TENANT_ID"
        "NEXT_PUBLIC_BATTLENET_ENABLED"
        "BATTLENET_CUSTOM_NAME"
        "BATTLENET_CLIENT_ID"
        "BATTLENET_CLIENT_SECRET"
        "BATTLENET_ISSUER"
        "NEXT_PUBLIC_BOX_ENABLED"
        "BOX_CUSTOM_NAME"
        "BOX_CLIENT_ID"
        "BOX_CLIENT_SECRET"
        "NEXT_PUBLIC_BUNGIE_ENABLED"
        "BUNGIE_CUSTOM_NAME"
        "BUNGIE_CLIENT_ID"
        "BUNGIE_CLIENT_SECRET"
        "BUNGIE_API_KEY"
        "NEXT_PUBLIC_COGNITO_ENABLED"
        "COGNITO_CUSTOM_NAME"
        "COGNITO_CLIENT_ID"
        "COGNITO_CLIENT_SECRET"
        "COGNITO_ISSUER"
        "NEXT_PUBLIC_COINBASE_ENABLED"
        "COINBASE_CUSTOM_NAME"
        "COINBASE_CLIENT_ID"
        "COINBASE_CLIENT_SECRET"
        "NEXT_PUBLIC_DISCORD_ENABLED"
        "DISCORD_CUSTOM_NAME"
        "DISCORD_CLIENT_ID"
        "DISCORD_CLIENT_SECRET"
        "NEXT_PUBLIC_DROPBOX_ENABLED"
        "DROPBOX_CUSTOM_NAME"
        "DROPBOX_CLIENT_ID"
        "DROPBOX_CLIENT_SECRET"
        "NEXT_PUBLIC_DUENDE_IDS6_ENABLED"
        "DUENDE_IDS6_CUSTOM_NAME"
        "DUENDE_IDS6_CLIENT_ID"
        "DUENDE_IDS6_CLIENT_SECRET"
        "DUENDE_IDS6_ISSUER"
        "NEXT_PUBLIC_EVEONLINE_ENABLED"
        "EVEONLINE_CUSTOM_NAME"
        "EVEONLINE_CLIENT_ID"
        "EVEONLINE_CLIENT_SECRET"
        "NEXT_PUBLIC_FACEBOOK_ENABLED"
        "FACEBOOK_CUSTOM_NAME"
        "FACEBOOK_CLIENT_ID"
        "FACEBOOK_CLIENT_SECRET"
        "NEXT_PUBLIC_FACEIT_ENABLED"
        "FACEIT_CUSTOM_NAME"
        "FACEIT_CLIENT_ID"
        "FACEIT_CLIENT_SECRET"
        "NEXT_PUBLIC_FOURSQUARE_ENABLED"
        "FOURSQUARE_CUSTOM_NAME"
        "FOURSQUARE_CLIENT_ID"
        "FOURSQUARE_CLIENT_SECRET"
        "FOURSQUARE_APIVERSION"
        "NEXT_PUBLIC_FRESHBOOKS_ENABLED"
        "FRESHBOOKS_CUSTOM_NAME"
        "FRESHBOOKS_CLIENT_ID"
        "FRESHBOOKS_CLIENT_SECRET"
        "NEXT_PUBLIC_FUSIONAUTH_ENABLED"
        "FUSIONAUTH_CUSTOM_NAME"
        "FUSIONAUTH_CLIENT_ID"
        "FUSIONAUTH_CLIENT_SECRET"
        "FUSIONAUTH_ISSUER"
        "FUSIONAUTH_TENANT_ID"
        "NEXT_PUBLIC_GITHUB_ENABLED"
        "GITHUB_CUSTOM_NAME"
        "GITHUB_ID"
        "GITHUB_SECRET"
        "NEXT_PUBLIC_GITLAB_ENABLED"
        "GITLAB_CUSTOM_NAME"
        "GITLAB_CLIENT_ID"
        "GITLAB_CLIENT_SECRET"
        "NEXT_PUBLIC_GOOGLE_ENABLED"
        "GOOGLE_CUSTOM_NAME"
        "GOOGLE_CLIENT_ID"
        "GOOGLE_CLIENT_SECRET"
        "NEXT_PUBLIC_HUBSPOT_ENABLED"
        "HUBSPOT_CUSTOM_NAME"
        "HUBSPOT_CLIENT_ID"
        "HUBSPOT_CLIENT_SECRET"
        "NEXT_PUBLIC_IDS4_ENABLED"
        "IDS4_CUSTOM_NAME"
        "IDS4_CLIENT_ID"
        "IDS4_CLIENT_SECRET"
        "IDS4_ISSUER"
        "NEXT_PUBLIC_KAKAO_ENABLED"
        "KAKAO_CUSTOM_NAME"
        "KAKAO_CLIENT_ID"
        "KAKAO_CLIENT_SECRET"
        "NEXT_PUBLIC_KEYCLOAK_ENABLED"
        "KEYCLOAK_CUSTOM_NAME"
        "KEYCLOAK_ISSUER"
        "KEYCLOAK_CLIENT_ID"
        "KEYCLOAK_CLIENT_SECRET"
        "NEXT_PUBLIC_LINE_ENABLED"
        "LINE_CUSTOM_NAME"
        "LINE_CLIENT_ID"
        "LINE_CLIENT_SECRET"
        "NEXT_PUBLIC_LINKEDIN_ENABLED"
        "LINKEDIN_CUSTOM_NAME"
        "LINKEDIN_CLIENT_ID"
        "LINKEDIN_CLIENT_SECRET"
        "NEXT_PUBLIC_MAILCHIMP_ENABLED"
        "MAILCHIMP_CUSTOM_NAME"
        "MAILCHIMP_CLIENT_ID"
        "MAILCHIMP_CLIENT_SECRET"
        "NEXT_PUBLIC_MAILRU_ENABLED"
        "MAILRU_CUSTOM_NAME"
        "MAILRU_CLIENT_ID"
        "MAILRU_CLIENT_SECRET"
        "NEXT_PUBLIC_NAVER_ENABLED"
        "NAVER_CUSTOM_NAME"
        "NAVER_CLIENT_ID"
        "NAVER_CLIENT_SECRET"
        "NEXT_PUBLIC_NETLIFY_ENABLED"
        "NETLIFY_CUSTOM_NAME"
        "NETLIFY_CLIENT_ID"
        "NETLIFY_CLIENT_SECRET"
        "NEXT_PUBLIC_OKTA_ENABLED"
        "OKTA_CUSTOM_NAME"
        "OKTA_CLIENT_ID"
        "OKTA_CLIENT_SECRET"
        "OKTA_ISSUER"
        "NEXT_PUBLIC_ONELOGIN_ENABLED"
        "ONELOGIN_CUSTOM_NAME"
        "ONELOGIN_CLIENT_ID"
        "ONELOGIN_CLIENT_SECRET"
        "ONELOGIN_ISSUER"
        "NEXT_PUBLIC_OSSO_ENABLED"
        "OSSO_CUSTOM_NAME"
        "OSSO_CLIENT_ID"
        "OSSO_CLIENT_SECRET"
        "OSSO_ISSUER"
        "NEXT_PUBLIC_OSU_ENABLED"
        "OSU_CUSTOM_NAME"
        "OSU_CLIENT_ID"
        "OSU_CLIENT_SECRET"
        "NEXT_PUBLIC_PATREON_ENABLED"
        "PATREON_CUSTOM_NAME"
        "PATREON_CLIENT_ID"
        "PATREON_CLIENT_SECRET"
        "NEXT_PUBLIC_PINTEREST_ENABLED"
        "PINTEREST_CUSTOM_NAME"
        "PINTEREST_CLIENT_ID"
        "PINTEREST_CLIENT_SECRET"
        "NEXT_PUBLIC_PIPEDRIVE_ENABLED"
        "PIPEDRIVE_CUSTOM_NAME"
        "PIPEDRIVE_CLIENT_ID"
        "PIPEDRIVE_CLIENT_SECRET"
        "NEXT_PUBLIC_REDDIT_ENABLED"
        "REDDIT_CUSTOM_NAME"
        "REDDIT_CLIENT_ID"
        "REDDIT_CLIENT_SECRET"
        "NEXT_PUBLIC_SALESFORCE_ENABLED"
        "SALESFORCE_CUSTOM_NAME"
        "SALESFORCE_CLIENT_ID"
        "SALESFORCE_CLIENT_SECRET"
        "NEXT_PUBLIC_SLACK_ENABLED"
        "SLACK_CUSTOM_NAME"
        "SLACK_CLIENT_ID"
        "SLACK_CLIENT_SECRET"
        "NEXT_PUBLIC_SPOTIFY_ENABLED"
        "SPOTIFY_CUSTOM_NAME"
        "SPOTIFY_CLIENT_ID"
        "SPOTIFY_CLIENT_SECRET"
        "NEXT_PUBLIC_STRAVA_ENABLED"
        "STRAVA_CUSTOM_NAME"
        "STRAVA_CLIENT_ID"
        "STRAVA_CLIENT_SECRET"
        "NEXT_PUBLIC_TODOIST_ENABLED"
        "TODOIST_CUSTOM_NAME"
        "TODOIST_CLIENT_ID"
        "TODOIST_CLIENT_SECRET"
        "NEXT_PUBLIC_TWITCH_ENABLED"
        "TWITCH_CUSTOM_NAME"
        "TWITCH_CLIENT_ID"
        "TWITCH_CLIENT_SECRET"
        "NEXT_PUBLIC_UNITED_EFFECTS_ENABLED"
        "UNITED_EFFECTS_CUSTOM_NAME"
        "UNITED_EFFECTS_CLIENT_ID"
        "UNITED_EFFECTS_CLIENT_SECRET"
        "UNITED_EFFECTS_ISSUER"
        "NEXT_PUBLIC_VK_ENABLED"
        "VK_CUSTOM_NAME"
        "VK_CLIENT_ID"
        "VK_CLIENT_SECRET"
        "NEXT_PUBLIC_WIKIMEDIA_ENABLED"
        "WIKIMEDIA_CUSTOM_NAME"
        "WIKIMEDIA_CLIENT_ID"
        "WIKIMEDIA_CLIENT_SECRET"
        "NEXT_PUBLIC_WORDPRESS_ENABLED"
        "WORDPRESS_CUSTOM_NAME"
        "WORDPRESS_CLIENT_ID"
        "WORDPRESS_CLIENT_SECRET"
        "NEXT_PUBLIC_YANDEX_ENABLED"
        "YANDEX_CUSTOM_NAME"
        "YANDEX_CLIENT_ID"
        "YANDEX_CLIENT_SECRET"
        "NEXT_PUBLIC_ZITADEL_ENABLED"
        "ZITADEL_CUSTOM_NAME"
        "ZITADEL_CLIENT_ID"
        "ZITADEL_CLIENT_SECRET"
        "ZITADEL_ISSUER"
        "NEXT_PUBLIC_ZOHO_ENABLED"
        "ZOHO_CUSTOM_NAME"
        "ZOHO_CLIENT_ID"
        "ZOHO_CLIENT_SECRET"
        "NEXT_PUBLIC_ZOOM_ENABLED"
        "ZOOM_CUSTOM_NAME"
        "ZOOM_CLIENT_ID"
        "ZOOM_CLIENT_SECRET"

    )
    # If any secrets are set, prefer them over base environment variables.
    for var in "${secret_supported_vars[@]}"; do
        [[ -z "$var" ]] && continue  # Skip if var is empty
        file_var="$(echo "$var" | tr -d '\r\n')_FILE"
        if [ -n "${!file_var}" ]; then
            export "$var=$(<"${!file_var}")"
        fi
    done
}

add_user
change_user
load_secrets
check_postgres_connection

echo "Deploying via prisma..."
npx prisma migrate deploy

echo "Starting server"
yarn start
